---
- name: Test asdf installation and versions
  hosts: all
  vars:
    ruby_version_from_yml: "{{ lookup('file', '../../../defaults/main.yml') | from_yaml | json_query('ruby_version') }}"
    nodejs_version_from_yml: "{{ lookup('file', '../../../defaults/main.yml') | from_yaml | json_query('nodejs_version') }}"
    yarn_version_from_yml: "{{ lookup('file', '../../../defaults/main.yml') | from_yaml | json_query('yarn_version') }}"

  tasks:
    - name: Check if asdf is installed
      ansible.builtin.stat:
        path: ~/.asdf
      register: asdf_installed

    - name: Install asdf if not installed
      ansible.builtin.git:
        repo: "https://github.com/asdf-vm/asdf.git"
        dest: ~/.asdf
        version: "{{ asdf_version }}"
      when: not asdf_installed.stat.exists

    - name: Source asdf in current session for root user
      ansible.builtin.shell: |
        . /root/.asdf/asdf.sh && asdf --version
      register: asdf_version_check
      become: true # スーパーユーザーで実行
      changed_when: false

    - name: Ensure asdf is installed
      assert:
        that:
          - asdf_version_check.rc == 0

    - name: Check Ruby version only if asdf is installed
      ansible.builtin.shell: |
        . ~/.asdf/asdf.sh && asdf current ruby
      register: ruby_version
      when: asdf_version_check.rc == 0

    - name: Check Ruby version only if asdf is installed
      ansible.builtin.shell: |
        . ~/.asdf/asdf.sh && asdf current ruby
      register: ruby_version
      when: asdf_version_check.rc == 0

    - name: Ensure Ruby version matches the default version
      assert:
        that:
          - ruby_version.stdout.split()[1] == ruby_version_from_yml
      failed_when: ruby_version.stdout.split()[1] != ruby_version_from_yml

    - name: Check Node.js version only if asdf is installed
      ansible.builtin.shell: |
        . ~/.asdf/asdf.sh && asdf current nodejs
      register: nodejs_version
      when: asdf_version_check.rc == 0

    - name: Ensure Node.js version matches the default version
      assert:
        that:
          - nodejs_version.stdout.split()[1] == nodejs_version_from_yml
      failed_when: nodejs_version.stdout.split()[1] != nodejs_version_from_yml

    - name: Check Yarn version only if asdf is installed
      ansible.builtin.shell: |
        . ~/.asdf/asdf.sh && asdf current yarn
      register: yarn_version
      when: asdf_version_check.rc == 0

    - name: Ensure Yarn version matches the default version
      assert:
        that:
          - yarn_version.stdout.split()[1] == yarn_version_from_yml
      failed_when: yarn_version.stdout.split()[1] != yarn_version_from_yml
