---
- name: Test JTalk package installation
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Ensure required packages are installed
      package:
        name:
          - tar
          - gzip
          - unzip
          - wget
          - gcc
          - make
          - automake
          - autoconf
        state: present
      register: required_packages

    - name: Assert required packages are installed
      assert:
        that:
          - required_packages is succeeded

    - name: Check if source directory exists
      stat:
        path: /usr/local/src
      register: src_dir

    - name: Assert source directory exists
      assert:
        that:
          - src_dir.stat.exists
          - src_dir.stat.isdir

    - name: Verify packages downloaded
      stat:
        path: "/usr/local/src/{{ item.name }}.tar.gz"
      loop: "{{ packages }}"
      register: packages_downloaded

    - name: Assert packages are downloaded
      assert:
        that:
          - packages_downloaded.results | map(attribute='stat.exists') | select('equalto', true) | list | length == packages | length

    - name: Verify packages extracted
      stat:
        path: "/usr/local/src/{{ item.name }}"
      loop: "{{ packages }}"
      register: packages_extracted

    - name: Assert packages are extracted
      assert:
        that:
          - packages_extracted.results | map(attribute='stat.isdir') | select('equalto', true) | list | length == packages | length

    - name: Verify binaries installed
      stat:
        path: "/usr/local/bin/{{ item.binary }}"
      loop: "{{ packages }}"
      register: binaries_installed

    - name: Assert binaries are installed
      assert:
        that:
          - binaries_installed.results | map(attribute='stat.exists') | select('equalto', true) | list | length == packages | length
